name: Provision AD User & Store in Akeyless

on:
  workflow_dispatch:

permissions:
  id-token: write  # Required for JWT authentication
  contents: read   # Allows access to repo contents

jobs:
  provision_ad_user:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch LDAP Dynamic Secret from Akeyless
        id: fetch_ldap_secret
        uses: akeyless-community/akeyless-github-action@v1.1.2
        with:
          access-id: ${{ vars.AKEYLESS_ACCESS_ID }}
          access-type: jwt
          api-url: "https://api.akeyless.io"
          dynamic-secrets: |
            - name: "/CS/Azure/Domain-akeyless.site/LDAP/LDAP-temp-domain-user-AD"
              output-name: "ldap_secret"

# Export Dynamic Secret's keys to env vars
      - name: Export LDAP DS json keys (creds) to Env variables
        run: |
          echo '${{ steps.fetch_ldap_secret.outputs.ldap_secret }}' | jq -r 'to_entries|map("LDAP_\(.key|ascii_upcase)=\(.value|tostring)")|.[]' >> $GITHUB_ENV

      - name: Install Akeyless CLI
        run: |
          curl -o akeyless https://akeyless-cli.s3.us-east-2.amazonaws.com/cli/latest/production/cli-linux-amd64
          chmod +x akeyless
          ./akeyless --init

      - name: Store LDAP Credentials in Akeyless as a Rotated Secret (Manual Mode)
        run: |
          ./akeyless rotated-secret create ldap \
          --name "/demo/shared_with_me/netser.h@akeyless.io/LMS_credential" \
          --gateway-url "https://conf.nh.cs.akeyless.fans" \
          --target-name "/CS/Azure/LDAP/AD-ldap-sandbox-akeyless-site" \
          --authentication-credentials "use-target-creds" \
          --password-length 16 \
          --rotator-type "ldap" \
          --rotated-username "${{ env.LDAP_USER }}" \
          --rotated-password "${{ env.LDAP_PASSWORD }}" \
          --user-attribute "sAMAccountName" \
          --user-dn "CN=\"${{ env.LDAP_USER }}\",OU=netser,DC=akeyless,DC=site" \
          --token "${{ steps.fetch_ldap_secret.outputs.token }}" \
          --auto-rotate "false"

      - name: Output Stored Secret Path
        run: |
          echo "âœ… Stored Secret Path: /demo/shared_with_me/testuser@example.com/LMS_credential"
